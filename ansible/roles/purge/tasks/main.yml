# vim: ft=yaml.ansible

- name: Set distribution-specific variables
  ansible.builtin.include_vars:
    file: "{{ ansible_facts['distribution'] | replace(' ', '_') }}.yml"

- name: Purge and lock unwanted packages (openSUSE Tumbleweed)
  become: true
  when: ansible_facts["distribution"] == "openSUSE Tumbleweed"
  block:
    - name: Remove unwanted packages (openSUSE Tumbleweed)
      ansible.builtin.command:
        cmd: "/usr/bin/zypper --quiet --non-interactive --xmlout remove '{{ item }}'"
      loop: "{{ purge_packages }}"
      register: zypper_remove
      changed_when: zypper_remove.rc == 0
      ignore_errors: true

    - name: Add package locks
      ansible.builtin.command:
        cmd: "/usr/bin/zypper --quiet --non-interactive --xmlout addlock '{{ item }}'"
      loop: "{{ purge_packages }}"
      register: zypper_addlock
      changed_when: "'<locks' in zypper_addlock.stdout"

- name: Purge unwanted packages (Debian-based)
  become: true
  ansible.builtin.apt:
    name: "{{ purge_packages }}"
    state: absent
    purge: true
  when: ansible_facts["os_family"] == "Debian"
